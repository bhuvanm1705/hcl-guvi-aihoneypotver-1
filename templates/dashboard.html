<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honeypot Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #020617;
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.05);
        }

        .neon-text {
            text-shadow: 0 0 5px rgba(56, 189, 248, 0.5);
        }

        .grid-bg {
            background-image: linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .blink {
            animation: blinker 1.5s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        /* Flash Animation */
        @keyframes flash-red {

            0%,
            100% {
                border-color: rgba(56, 189, 248, 0.2);
                box-shadow: none;
            }

            50% {
                border-color: #ef4444;
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            }
        }

        .flash-alert {
            animation: flash-red 1s ease-in-out infinite;
        }

        #interactive-map {
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 1;
        }

        .leaflet-control-zoom a {
            background-color: rgba(15, 23, 42, 0.9) !important;
            color: #22d3ee !important;
            border: 1px solid #22d3ee !important;
        }

        .leaflet-bar {
            border: none !important;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.95);
            color: #ecfeff;
            border: 1px solid #06b6d4;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }

        .leaflet-popup-tip {
            background: #06b6d4;
        }

        .custom-div-icon {
            background: transparent;
            border: none;
        }

        .marker-pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 10px currentColor;
        }

        .pin-cyan {
            background: #06b6d4;
            color: #06b6d4;
            border: 2px solid white;
        }

        .pin-red {
            background: #ef4444;
            color: #ef4444;
        }

        .pin-red::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid #ef4444;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                width: 100%;
                height: 100%;
                opacity: 1;
            }

            100% {
                width: 300%;
                height: 300%;
                opacity: 0;
            }
        }

        .pin-blue {
            background: #3b82f6;
            color: #3b82f6;
            border: 2px solid white;
            box-shadow: 0 0 20px #3b82f6;
        }

        /* Tactic Badge */
        .tactic-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 4px;
            border: 1px solid;
        }

        .tactic-urgency {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .tactic-fear {
            border-color: #a855f7;
            color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .tactic-reward {
            border-color: #eab308;
            color: #eab308;
            background: rgba(234, 179, 8, 0.1);
        }

        .tactic-authority {
            border-color: #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body class="text-cyan-50 min-h-screen grid-bg overflow-hidden flex flex-col p-4">

    <!-- Header -->
    <header class="flex justify-between items-center mb-4 px-2">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-cyan-400 rounded-full blink"></div>
            <div>
                <h1 class="text-2xl font-bold tracking-wider neon-text text-cyan-400">AGENTIC HONEYPOT <span
                        class="text-xs text-cyan-700 ml-2">v4.0-JUDGE-READY</span></h1>
                <p class="text-xs text-slate-400">DEPLOYMENT ID: <span id="deploy-time"
                        class="text-yellow-500 font-bold">LOADING...</span></p>
            </div>
        </div>
        <div class="glass px-4 py-2 rounded flex gap-6 text-xs bg-slate-900/50">
            <div>SERVER: <span class="text-green-400">ONLINE</span></div>
            <div>AGENTS: <span class="text-green-400">ACTIVE</span></div>
            <div>MODE: <span class="text-purple-400">OFFENSIVE DEFENSE</span></div>
        </div>
    </header>

    <!-- KPI Grid -->
    <div class="grid grid-cols-4 gap-4 mb-4">
        <div class="glass p-4 rounded-lg border-l-4 border-cyan-500">
            <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Total Intercepts</h3>
            <p class="text-3xl font-bold text-white mb-0" id="total-attacks">0</p>
            <div class="text-[10px] text-cyan-500 mt-1">â–² LIVE TRAFFIC</div>
        </div>
        <div class="glass p-4 rounded-lg border-l-4 border-red-500">
            <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Active Threats</h3>
            <p class="text-3xl font-bold text-red-400 mb-0" id="scams-detected">0</p>
            <div class="text-[10px] text-red-500 mt-1">BLOCKED & ENGAGED</div>
        </div>
        <div class="glass p-4 rounded-lg border-l-4 border-yellow-500">
            <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Intel Extracted</h3>
            <p class="text-3xl font-bold text-yellow-400 mb-0" id="intel-count">0</p>
            <div class="text-[10px] text-yellow-500 mt-1">UPI / PHONE / LINKS</div>
        </div>
        <!-- NEW: Dynamic Risk Score -->
        <div class="glass p-4 rounded-lg border-l-4 border-purple-500 relative overflow-hidden">
            <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Current Risk Score</h3>
            <div class="flex items-baseline gap-2">
                <p class="text-4xl font-bold text-purple-400 mb-0" id="risk-score-display">0</p>
                <span class="text-xs text-slate-500">/ 100</span>
            </div>
            <div class="absolute right-2 top-2 bottom-2 w-2 bg-slate-800 rounded overflow-hidden">
                <div id="risk-bar" class="w-full bg-purple-500 transition-all duration-1000 bottom-0 absolute"
                    style="height: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Area -->
    <div class="grid grid-cols-12 gap-4 flex-1 min-h-0">

        <!-- Left: Threat Intelligence & Map -->
        <div class="col-span-8 flex flex-col gap-4 min-h-0 h-full">

            <!-- Analysis Panel (Context Aware) -->
            <div class="glass p-4 rounded-lg h-1/4 relative flex flex-col overflow-hidden" id="analysis-panel">
                <div class="flex justify-between items-start z-10">
                    <div>
                        <h3 class="text-cyan-400 text-xs font-bold mb-1">LIVE THREAT ANALYTICS</h3>
                        <h2 class="text-2xl font-bold text-white mb-1" id="scam-type-display">WAITING FOR SIGNAL...</h2>
                        <div id="tactics-container" class="flex gap-2 mt-2">
                            <!-- Badges go here -->
                        </div>
                    </div>
                    <!-- Risk Graph (Small) -->
                    <div class="w-1/3 h-full absolute right-0 top-0 bottom-0 p-2 opacity-50">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="glass p-0 rounded-lg flex-1 relative overflow-hidden flex flex-col transition-all duration-300 border border-slate-700"
                id="map-panel">
                <div id="interactive-map"></div>
                <!-- Overlay Info -->
                <div
                    class="absolute bottom-4 left-4 z-[500] bg-slate-900/90 p-2 rounded border border-cyan-500/30 text-[10px]">
                    <div class="text-cyan-400 font-bold">GPS TRACKING ACTIVE</div>
                    <div class="text-slate-400">LAT: <span id="gps-lat">...</span> LON: <span id="gps-lon">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Logs & Intel -->
        <div class="col-span-4 flex flex-col gap-4 min-h-0 h-full">
            <div class="glass p-0 rounded-lg flex flex-col flex-1 overflow-hidden">
                <div class="bg-slate-900/80 p-2 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs text-slate-400">SYSTEM LOGS</span>
                    <div class="flex gap-1">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    </div>
                </div>
                <div class="p-3 overflow-y-auto font-mono text-[11px] space-y-1 flex-1 h-full scrollbar-thin"
                    id="activity-log">
                    <div class="text-slate-500">System initialized...</div>
                </div>
            </div>

            <div class="glass p-4 rounded-lg h-1/3 flex flex-col">
                <h3 class="text-yellow-400 text-xs font-bold mb-3">EXTRACTED EVIDENCE</h3>
                <div class="overflow-y-auto space-y-2 flex-1" id="intel-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Init
        const now = new Date();
        document.getElementById('deploy-time').innerText = now.toLocaleTimeString();

        // --- Charts ---
        const ctxRisk = document.getElementById('riskChart').getContext('2d');
        const riskChart = new Chart(ctxRisk, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'Risk Score',
                    data: Array(20).fill(0),
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false, min: 0, max: 100 } },
                animation: { duration: 0 }
            }
        });

        // --- Map Setup ---
        const map = L.map('interactive-map', { zoomControl: true, attributionControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        // Bounds
        map.setMaxBounds([[5.0, 68.0], [38.0, 98.0]]);
        map.setMinZoom(4);

        // Icons
        const icons = {
            cyan: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin pin-cyan'></div>", iconSize: [20, 20] }),
            red: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin pin-red'></div>", iconSize: [20, 20] }),
            blue: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin pin-blue'></div>", iconSize: [20, 20] })
        };

        // GPS
        map.locate({ setView: true, maxZoom: 6 });
        map.on('locationfound', e => {
            L.marker(e.latlng, { icon: icons.blue }).addTo(map).bindPopup("<b>HQ (YOU)</b>").openPopup();
            document.getElementById('gps-lat').innerText = e.latlng.lat.toFixed(4);
            document.getElementById('gps-lon').innerText = e.latlng.lng.toFixed(4);
        });

        // --- Live Data ---
        let lastRiskScore = 0;
        let lastMsgCount = 0;

        // Mock Threat Locations
        const threats = [
            { lat: 28.61, lng: 77.20, name: "New Delhi" }, { lat: 19.07, lng: 72.87, name: "Mumbai" },
            { lat: 22.57, lng: 88.36, name: "Kolkata" }, { lat: 24.16, lng: 86.60, name: "Jamtara" },
            { lat: 12.97, lng: 77.59, name: "Bangalore" }
        ];

        function getTacticBadge(tactic) {
            const map = { 'Urgency': 'tactic-urgency', 'Fear': 'tactic-fear', 'Greed': 'tactic-reward', 'Reward': 'tactic-reward', 'Authority': 'tactic-authority' };
            const cls = map[tactic] || 'tactic-authority';
            return `<span class="tactic-badge ${cls}">${tactic.toUpperCase()}</span>`;
        }

        function updateStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    // 1. Basic KPI
                    document.getElementById('total-attacks').innerText = data.total_messages;
                    document.getElementById('scams-detected').innerText = data.scams_detected;
                    document.getElementById('intel-count').innerText = data.total_intelligence;

                    // 2. Risk Score & Graph
                    const currentRisk = data.latest_threat ? data.latest_threat.risk : 0;
                    document.getElementById('risk-score-display').innerText = currentRisk;
                    document.getElementById('risk-bar').style.height = `${currentRisk}%`;

                    // Update Graph
                    const chartData = riskChart.data.datasets[0].data;
                    chartData.shift();
                    chartData.push(currentRisk);
                    riskChart.update();

                    // 3. Thread Analysis Panel
                    if (data.latest_threat && currentRisk > 30) {
                        document.getElementById('scam-type-display').innerText = data.latest_threat.type.toUpperCase();
                        document.getElementById('scam-type-display').className = "text-2xl font-bold text-red-500 mb-1 animate-pulse";

                        // Tactics
                        const tacticsHtml = (data.latest_threat.tactics || []).map(getTacticBadge).join('');
                        document.getElementById('tactics-container').innerHTML = tacticsHtml;

                        // Flash Map if new
                        if (data.total_messages > lastMsgCount) {
                            document.getElementById('map-panel').classList.add('flash-alert');
                            setTimeout(() => document.getElementById('map-panel').classList.remove('flash-alert'), 1000);

                            // Plot Threat
                            const loc = threats[Math.floor(Math.random() * threats.length)];
                            L.marker([loc.lat, loc.lng], { icon: icons.red }).addTo(map)
                                .bindPopup(`<b>${data.latest_threat.type}</b><br>Risk: ${currentRisk}<br>Loc: ${loc.name}`).openPopup();
                        }
                    } else {
                        document.getElementById('scam-type-display').innerText = "MONITORING NETWORK...";
                        document.getElementById('scam-type-display').className = "text-2xl font-bold text-slate-600 mb-1";
                        document.getElementById('tactics-container').innerHTML = "";
                    }
                    lastMsgCount = data.total_messages;

                    // 4. Logs
                    const logContainer = document.getElementById('activity-log');
                    logContainer.innerHTML = '';
                    data.recent_logs.forEach(log => {
                        const div = document.createElement('div');
                        const color = log.is_scam ? (log.risk_score > 70 ? 'text-red-500 font-bold' : 'text-orange-400') : 'text-slate-400';
                        div.className = `${color} border-b border-slate-800/50 pb-1 mb-1`;
                        div.innerHTML = `<span class="opacity-50">${log.time}</span> ${log.message}`;
                        logContainer.append(div);
                    });

                    // 5. Intel
                    const intelList = document.getElementById('intel-list');
                    intelList.innerHTML = '';
                    data.recent_intelligence.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bg-slate-900/80 p-2 rounded border-l-2 mb-1 ' + (item.type === 'UPI-ID' ? 'border-purple-500' : 'border-yellow-500');
                        div.innerHTML = `<span class="text-[10px] text-slate-500 block">${item.type}</span><span class="text-xs font-mono text-white select-all">${item.value}</span>`;
                        intelList.append(div);
                    });
                });
        }
        setInterval(updateStats, 1000);
        updateStats();
    </script>
</body>

</html>